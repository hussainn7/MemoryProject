{% extends 'front-base.html.twig' %}

{% block body_id memory.thema.classname|default('bg-option-1') %}

{% block body %}
    <div class="container-fluid memory">

        {# Precompute valid photo archive early for reuse (main photo fallback + section) #}
        {% set validPhotoArchive = [] %}
        {% for photo in memory.photoArhive %}
            {% if photo.photo is not empty and photo.photo != memory.mainPhoto %}
                {% set validPhotoArchive = validPhotoArchive|merge([photo]) %}
            {% endif %}
        {% endfor %}

        {% if memory.qrUrl is defined %}
        <section class="container my-4">
            <img src="{{ memory.qrUrl|e('html_attr') }}"
                 alt="QR"
                 class="memory-qr img-fluid d-block mx-auto">
            {% if memory.qrNumber is defined %}
            <div class="text-center mt-2 fw-semibold">
                –ù–ï–ë–ï–°–ù–´–ô-–ê–†–•–ò–í.–†–§ ‚Ññ: {{ memory.qrNumber }}
            </div>
            {% endif %}
        </section>
        {% endif %}

        <div class="card gradient-info-bg3 m-t-0 m-b-0">
            <div class="card-body">
                <div class="container">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="photo ratio ratio-1x1 rounded overflow-hidden bg-dark-subtle">
                                {% set mainPhotoSrc =
                                    memory.mainPhoto
                                        ? asset('img/' ~ memory.mainPhoto)
                                        : (validPhotoArchive is not empty
                                            ? asset('img/' ~ validPhotoArchive[0].photo)
                                            : asset('assets/images/users/profile.jpg'))
                                %}
                                <img class="memory--photo w-100 h-100" src="{{ mainPhotoSrc }}" alt="memory" style="object-fit:cover">
                            </div>
                        </div>
                        <div class="col-md-9 d-flex flex-column">
                            <div class="memory--last-name text-uppercase display-4">
                                {{ memory.lastName|default('') }}
                            </div>
                            <div class="memory--full-name display-4">
                                <span class="memory--first-name">
                                    {{ memory.firstName|default('') }}
                                </span>
                                <span class="memory--patronymic">
                                    {{ memory.patronymic|default('') }}
                                </span>
                            </div>

                            <div class="memory--live h6">
                                {{ memory.dateBirth|date('d.m.Y') }} - {{ memory.dateDeads|date('d.m.Y') }}
                            </div>

                            <div class="memory-zg text-white text-uppercase mt-2 mb-2 h5">
                                {{ 'label.data.pagememory'|trans }}
                            </div>

                            <div class="memory-nav d-flex align-items-start flex-column gap-2">
                                {% if memory.wordsMemory is not empty %}
                                    <a href="#wordsMemory" class="btn waves-effect waves-light btn-dark btn-sm">{{ 'label.data.wordsMemory'|trans }}</a>
                                {% endif %}

                                <a href="#photoArhive" class="btn waves-effect waves-light btn-dark btn-sm">{{ 'label.data.photoarhive'|trans }}</a>

                                {% if memory.linksMemory is not empty %}
                                    <a href="#linksMemory" class="btn waves-effect waves-light btn-dark btn-sm">{{ 'label.data.linksMemory'|trans }}</a>
                                {% endif %}

                                {% if memory.biography %}
                                    <a href="#biography" class="btn waves-effect waves-light btn-dark btn-sm">{{ 'label.data.biography'|trans }}</a>
                                {% endif %}

                                {% if memory.burialPlace is not empty %}
                                    <a href="#burialPlace" class="btn waves-effect waves-light btn-dark btn-sm">{{ 'label.data.burialPlace'|trans }}</a>
                                {% endif %}
                            </div>


                            <div class="memory--epitaph">
                                <figure class=" text-end text-white">
                                    <blockquote class="blockquote">
                                        <p>
                                            {% if memory.epitaph %}
                                                {{ memory.epitaph[0].text|default('') }}
                                            {% endif %}
                                        </p>
                                    </blockquote>
                                    <figcaption class="blockquote-footer text-white">
                                        {% if memory.epitaph %}
                                            {{ memory.epitaph[0].subText|default('') }}
                                        {% endif %}
                                    </figcaption>
                                </figure>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>

        {% if  memory.wordsMemory is not empty  %}
            <div class="card w-100 my-4" id="wordsMemory">
                <div class="card-header bg-secondary">
                    <h4 class="mb-0 text-white text-uppercase">{{ 'label.data.wordsMemory'|trans }}</h4>
                </div>
                <div class="card-body p-4">
                    {% for words in memory.wordsMemory %}
                        <figure class="memory--words h6 text-end mt-3 mb-4">
                            <blockquote class="blockquote">
                                <p class="lead mb-2">
                                    {% if words.words %}
                                        {{ words.words|default('') }}
                                    {% endif %}
                                </p>
                            </blockquote>
                            <figcaption class="blockquote-footer">
                                {% if words.fromPeople %}
                                    {{ words.fromPeople|default('') }}
                                {% endif %}
                            </figcaption>
                        </figure>
                    {% endfor %}
                </div>
            </div>
        {% endif %}


        <div class="card w-100 my-4" id="photoArhive">
            <div class="card-header bg-secondary">
                <h4 class="mb-0 text-white text-uppercase">{{ 'label.data.photoarhive'|trans }}</h4>
            </div>
            <div class="card-body p-4">
                {% if validPhotoArchive is not empty %}
                    <div id="carouselExample" class="carousel slide carousel-dark">
                        <div class="carousel-inner">
                            {% for photo in validPhotoArchive %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <img src="{{ asset('img/' ~ photo.photo) }}"
                                         class="memory--photoArhive-photo d-block w-100" alt="photo"
                                         style="max-height:520px; width:100%; object-fit:contain; background:rgba(0,0,0,.05);">
                                </div>
                            {% endfor %}
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">–î–∞–ª–µ–µ</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden"> –ù–∞–∑–∞–¥ </span>
                        </button>
                    </div>
                {% else %}
                    <div class="alert alert-secondary mb-0">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>
                {% endif %}
                
                {# Upload element for adding more photos #}
                <div class="mt-4">
                    <input type="hidden" class="js--uuid" value="{{ uuid }}" />
                    <div id="js--upload-person-photo-arhive"></div>
                </div>
            </div>
        </div>


        {% if  memory.linksMemory is not empty  %}
            <div class="card w-100 my-4" id="linksMemory">
                <div class="card-header bg-secondary">
                    <h4 class="mb-0 text-white text-uppercase">{{ 'label.data.linksMemory'|trans }}</h4>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex align-items-start flex-column gap-2">
                        {% for link in memory.linksMemory %}
                            <a target="_blank" class="btn waves-effect waves-light btn-dark"
                               href="{{ link.link|default('#') }}">{{ link.linkText|default('–ê–¥—Ä–µ—Å—Å —Å—Å—ã–ª–∫–∏') }}</a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}

        {% if memory.biography %}
            <div class="card w-100 my-4" id="biography">
                <div class="card-header bg-secondary text-uppercase">
                    <h4 class="mb-0 text-white">{{ 'label.data.biography'|trans }}</h4>
                </div>
                <div class="card-body p-4 memory--biography lead">
                    {{ memory.biography|nl2br }}
                </div>
            </div>
        {% endif %}

        {% if memory.burialPlace is not empty %}
            <div class="card w-100 my-4" id="burialPlace">
                <div class="card-header bg-secondary text-uppercase">
                    <h4 class="mb-0 text-white">{{ 'label.data.burialPlace'|trans }}</h4>
                </div>
                <div class="card-body p-4 memory--burialPlace">
                    <div class="memory--burialPlace-map mb-3" id="mapBurialPlace"
                         data-lng="{% if memory.burialPlace is not empty and memory.burialPlace|length > 0 and memory.burialPlace|first.lng is not null and memory.burialPlace|first.lng is not empty %}{{ memory.burialPlace|first.lng }}{% else %}37.554263{% endif %}"
                         data-lat="{% if memory.burialPlace is not empty and memory.burialPlace|length > 0 and memory.burialPlace|first.lat is not null and memory.burialPlace|first.lat is not empty %}{{ memory.burialPlace|first.lat }}{% else %}55.724596{% endif %}"
                         data-address="{% if memory.burialPlace is not empty and memory.burialPlace|length > 0 and memory.burialPlace|first.adress is not null and memory.burialPlace|first.adress is not empty %}{{ memory.burialPlace|first.adress|e('html_attr') }}{% else %}{% endif %}"
                         data-first-name="{{ memory.firstName|default('')|e('html_attr') }}"
                         data-last-name="{{ memory.lastName|default('')|e('html_attr') }}"
                         data-patronymic="{{ memory.patronymic|default('')|e('html_attr') }}"
                         data-debug-coords="{% if memory.burialPlace is not empty and memory.burialPlace|length > 0 %}lat:{{ memory.burialPlace|first.lat }},lng:{{ memory.burialPlace|first.lng }}{% else %}default{% endif %}"
                         style="height: 400px; width: 100%; border: 1px solid #ddd; border-radius: 8px;"></div>
                    <div class="mb-3">
                        <button type="button" id="getDirectionsBtn" class="btn btn-primary btn-sm">
                            <i class="fas fa-directions"></i> {{ 'label.burialPlace.get_directions'|trans }}
                        </button>
                        <button type="button" id="openInYandexBtn" class="btn btn-outline-secondary btn-sm ms-2">
                            <i class="fas fa-external-link-alt"></i> {{ 'label.burialPlace.open_in_yandex'|trans }}
                        </button>
                    </div>
                    <p class="lead font-bold mb-2">{{ 'label.data.burialPlace.adress'|trans }}</p>
                    <p class="lead text-black memory--burialPlace-adress">{% if memory.burialPlace is not empty and memory.burialPlace|length > 0 and memory.burialPlace|first.adress is not empty %}{{ memory.burialPlace|first.adress }}{% else %}–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω{% endif %}</p>
                </div>
            </div>
        {% endif %}


        <div class="card w-100 my-4">
            <div class="card-header bg-secondary text-uppercase">
                <h4 class="mb-0 text-white">{{ 'label.data.change_information'|trans }}</h4>
            </div>
            <div class="card-body p-4">
                <a href="javascript:void(0)"
                   class="btn waves-effect waves-light btn-dark js--send-change-memory-link"
                    data-uuid="{{ uuid|default('')}}"
                >{{ 'label.data.change_information_link'|trans }}</a>

                <button type="button" class="btn btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#changeRequestModal">
                    –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è / –§–æ—Ç–æ
                </button>
            </div>
        </div>

        {% include 'frontend/person/_modal_change_request.html.twig' %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        // ‚úÖ CRITICAL: Set these BEFORE person-form.js loads
        // Calculate validPhotoArchive count (exclude main photo from archive)
        {% set validPhotoArchiveCount = 0 %}
        {% for photo in memory.photoArhive %}
            {% if photo.photo is not empty and photo.photo != memory.mainPhoto %}
                {% set validPhotoArchiveCount = validPhotoArchiveCount + 1 %}
            {% endif %}
        {% endfor %}
        
        window.currentArchiveCount = {{ validPhotoArchiveCount }};
        window.memoryIsExtended = {{ memory.isExtended ? 'true' : 'false' }};
        window.photoExtensionPrice = {{ photo_extension_price|default(500) }};
        
        console.log('üîß Page loaded with:', {
            currentArchiveCount: window.currentArchiveCount,
            memoryIsExtended: window.memoryIsExtended,
            photoExtensionPrice: window.photoExtensionPrice,
        });
        
        $(function () {
            // Initialize burial place map on memory page
            // COMMENTED OUT: Map initialization disabled to prevent doubling
            // initBurialPlaceMap();
        });

        /* COMMENTED OUT: Map disabled on memory page
        function initBurialPlaceMap() {
            const mapElement = document.getElementById('mapBurialPlace');
            if (!mapElement) return;

            // Prevent multiple initializations
            if (window.burialPlaceMapInitialized) {
                console.log('Burial place map already initialized, skipping...');
                return;
            }

            // Set flag immediately to prevent race conditions
            window.burialPlaceMapInitialized = true;

            // (Leaflet fallback handled later)

            const latAttr = mapElement.getAttribute('data-lat');
            const lngAttr = mapElement.getAttribute('data-lng');
            const addressAttr = mapElement.getAttribute('data-address') || '';
            const firstNameAttr = mapElement.getAttribute('data-first-name') || '';
            const lastNameAttr = mapElement.getAttribute('data-last-name') || '';
            const patronymicAttr = mapElement.getAttribute('data-patronymic') || '';

            console.log('üîç Burial place map raw data attributes:', {
                latAttr: latAttr,
                lngAttr: lngAttr,
                addressAttr: addressAttr,
                rawLat: typeof latAttr,
                rawLng: typeof lngAttr
            });

            const decodeHtml = (value) => {
                if (!value) {
                    return '';
                }
                const textarea = document.createElement('textarea');
                textarea.innerHTML = value;
                return textarea.value;
            };
            const storedAddress = decodeHtml(addressAttr);
            const firstName = decodeHtml(firstNameAttr);
            const lastName = decodeHtml(lastNameAttr);
            const patronymic = decodeHtml(patronymicAttr);
            
            // Parse coordinates - handle both string and number inputs
            // Also handle empty strings, null, undefined, and "0" values
            const latStr = latAttr ? String(latAttr).trim() : '';
            const lngStr = lngAttr ? String(lngAttr).trim() : '';
            const lat = latStr && latStr !== '' && latStr !== '0' ? parseFloat(latStr) : NaN;
            const lng = lngStr && lngStr !== '' && lngStr !== '0' ? parseFloat(lngStr) : NaN;

            console.log('üìç Parsed coordinates:', { 
                lat, 
                lng, 
                latIsValid: !Number.isNaN(lat) && lat !== 0,
                lngIsValid: !Number.isNaN(lng) && lng !== 0,
                storedAddress 
            });

            // Check if we have valid coordinates (not NaN, not 0, and within reasonable bounds)
            const hasValidCoords = !Number.isNaN(lat) && !Number.isNaN(lng) && 
                                   lat !== 0 && lng !== 0 &&
                                   lat >= -90 && lat <= 90 && 
                                   lng >= -180 && lng <= 180;
            const defaultLat = 55.724596; // Moscow coordinates as default
            const defaultLng = 37.554263;

            const finalLat = hasValidCoords ? lat : defaultLat;
            const finalLng = hasValidCoords ? lng : defaultLng;

            console.log('üó∫Ô∏è Final map coordinates:', { 
                finalLat, 
                finalLng, 
                hasValidCoords,
                usingDefaults: !hasValidCoords
            });

            const unknownAddressLabel = '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
            const addressElement = document.querySelector('.memory--burialPlace-adress');
            const nameParts = [lastName, firstName, patronymic].map(part => part ? part.trim() : '').filter(Boolean);
            const personLabel = nameParts.join(' ').trim() || '–ú–µ—Å—Ç–æ –∑–∞—Ö–æ—Ä–æ–Ω–µ–Ω–∏—è';

            let currentAddress = storedAddress.trim();

            const sanitize = (value) => {
                if (!value) {
                    return '';
                }
                if (typeof ymaps !== 'undefined' && ymaps.util && ymaps.util.escapeHtml) {
                    return ymaps.util.escapeHtml(value);
                }
                const div = document.createElement('div');
                div.textContent = value;
                return div.innerHTML;
            };

            const buildBalloonContent = (address) => {
                const safeName = sanitize(personLabel);
                const safeAddress = sanitize(address);
                return safeAddress ? `${safeName}<br>${safeAddress}` : safeName;
            };

            const updateAddress = (address) => {
                const cleanedAddress = address && address.trim() ? address.trim() : '';
                currentAddress = cleanedAddress;
                if (addressElement) {
                    addressElement.textContent = cleanedAddress || unknownAddressLabel;
                }
                mapElement.dataset.address = cleanedAddress;
            };

            // Clear any existing content in the map container
            mapElement.innerHTML = '';

            // Wait for Yandex Maps to load (it's loaded in base template)
            const waitForYandexMaps = (attempts = 0) => {
                if (typeof ymaps !== 'undefined' && typeof ymaps.ready === 'function') {
                    // Yandex Maps is loaded, initialize the map
                    ymaps.ready(function () {
                        initializeYandexMap();
                    });
                } else if (attempts < 15) {
                    // Wait up to 3 seconds for Yandex Maps to load (15 attempts * 200ms)
                    setTimeout(() => waitForYandexMaps(attempts + 1), 200);
                } else {
                    // Fallback to Leaflet if Yandex Maps doesn't load
                    console.warn('Yandex Maps failed to load, using Leaflet fallback');
                    initializeLeafletFallback();
                }
            };

            const initializeLeafletFallback = () => {
                const showFallback = () => {
                    $('#mapBurialPlace').html('<div class="alert alert-warning p-3"><i class="fas fa-exclamation-triangle me-2"></i>–ö–∞—Ä—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>');
                };

                const ensureLeaflet = () => new Promise((resolve, reject) => {
                    const css = document.createElement('link');
                    css.rel = 'stylesheet';
                    css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                    css.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
                    css.crossOrigin = '';
                    document.head.appendChild(css);

                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                    script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
                    script.crossOrigin = '';
                    script.onload = () => resolve();
                    script.onerror = () => reject();
                    document.body.appendChild(script);
                });

                ensureLeaflet().then(() => {
                    try {
                        const map = L.map('mapBurialPlace').setView([finalLat, finalLng], hasValidCoords ? 15 : 10);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
                        if (hasValidCoords) {
                            const marker = L.marker([finalLat, finalLng]).addTo(map);
                            const popupHtml = personLabel + (currentAddress ? '<br>' + currentAddress : '');
                            marker.bindPopup(popupHtml).openPopup();
                            window.burialPlacePlacemarkView = marker;
                        }
                        window.burialPlaceMapView = map;
                        window.burialPlaceMapInitialized = true;
                    } catch (e) {
                        console.error('Leaflet map fallback failed:', e);
                        showFallback();
                    }
                }).catch(() => showFallback());
            };

            const initializeYandexMap = () => {
                try {
                    console.log('üó∫Ô∏è Initializing Yandex map with center:', [finalLat, finalLng]);
                    
                    const map = new ymaps.Map('mapBurialPlace', {
                        center: [finalLat, finalLng],
                        zoom: hasValidCoords ? 15 : 10,
                        controls: ['zoomControl', 'fullscreenControl']
                    });

                    let placemark = null;

                    // Always create a placemark if we have coordinates (even if using defaults)
                    if (hasValidCoords) {
                        console.log('üìç Creating placemark at:', [finalLat, finalLng]);
                        placemark = new ymaps.Placemark([finalLat, finalLng], {
                            hintContent: sanitize(currentAddress || personLabel),
                            balloonContent: buildBalloonContent(currentAddress)
                        }, {
                            preset: 'islands#redIcon',
                            iconColor: '#dc3545'
                        });

                        map.geoObjects.add(placemark);
                        console.log('‚úÖ Placemark added successfully');

                        if (!currentAddress) {
                            ymaps.geocode([finalLat, finalLng]).then(function (res) {
                                const geoObject = res.geoObjects.get(0);
                                const foundAddress = geoObject ? geoObject.getAddressLine() : '';

                                if (foundAddress) {
                                    updateAddress(foundAddress);
                                    placemark.properties.set('hintContent', sanitize(foundAddress));
                                    placemark.properties.set('balloonContent', buildBalloonContent(foundAddress));
                                }
                            }).catch(function (error) {
                                console.warn('Unable to determine burial address:', error);
                            });
                        } else {
                            updateAddress(currentAddress);
                        }
                    }

                    // Expose map instances for debugging/support tools
                    window.burialPlaceMapView = map;
                    if (placemark) {
                        window.burialPlacePlacemarkView = placemark;
                    }

                    // Get directions button - only show if we have valid burial coordinates
                    if (hasValidCoords) {
                        $('#getDirectionsBtn').on('click', function() {
                            if (navigator.geolocation) {
                                navigator.geolocation.getCurrentPosition(function(position) {
                                    const userLat = position.coords.latitude;
                                    const userLng = position.coords.longitude;

                                    // Open Yandex Maps with directions
                                    const url = `https://yandex.ru/maps/?rtext=${userLat},${userLng}~${finalLat},${finalLng}&rtt=auto`;
                                    window.open(url, '_blank');
                                }, function() {
                                    // Fallback: just open the location
                                    const url = `https://yandex.ru/maps/?ll=${finalLng},${finalLat}&z=16&pt=${finalLng},${finalLat}`;
                                    window.open(url, '_blank');
                                });
                            } else {
                                // Fallback: just open the location
                                const url = `https://yandex.ru/maps/?ll=${finalLng},${finalLat}&z=16&pt=${finalLng},${finalLat}`;
                                window.open(url, '_blank');
                            }
                        });

                        // Open in Yandex Maps button
                        $('#openInYandexBtn').on('click', function() {
                            const url = `https://yandex.ru/maps/?ll=${finalLng},${finalLat}&z=16&pt=${finalLng},${finalLat}`;
                            window.open(url, '_blank');
                        });
                    } else {
                        // Hide buttons if no valid coordinates
                        $('#getDirectionsBtn, #openInYandexBtn').hide();
                    }

                } catch (error) {
                    console.error('Burial place map initialization failed:', error);
                    $('#mapBurialPlace').html('<div class="alert alert-warning p-3"><i class="fas fa-exclamation-triangle me-2"></i>–ö–∞—Ä—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>');
                }
            };

            // Start waiting for Yandex Maps to load
            waitForYandexMaps();
        }
        */
    </script>

    <script>
        (function() {
            const form = document.getElementById('changeRequestForm');
            if (!form) return;

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const btns = form.querySelectorAll('button');
                btns.forEach(b => b.disabled = true);
                try {
                    const data = new FormData(form);
                    const res = await fetch('{{ path('person_submit_change_request', { uuid: uuid }) }}', {
                        method: 'POST',
                        body: data
                    });
                    const json = await res.json().catch(() => ({ success: false }));
                    if (!res.ok || json.success !== true) {
                        alert(json.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                        return;
                    }
                    alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –í–ª–∞–¥–µ–ª–µ—Ü —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.');
                    const modalEl = document.getElementById('changeRequestModal');
                    if (modalEl) {
                        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                        modal.hide();
                    }
                    form.reset();
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                } finally {
                    btns.forEach(b => b.disabled = false);
                }
            });
        })();
    </script>





{% endblock %}
